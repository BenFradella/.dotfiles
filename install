#!/bin/bash

set -e

source /etc/os-release

OS_ID=${ID_LIKE:-$ID}

case ${OS_ID} in
    debian)
        action=$(snap list bash-language-server &>/dev/null && echo "refresh" || echo "install")
        sudo snap ${action} bash-language-server
        sudo apt install --upgrade --quiet -y neovim python gcc ;;
    arch)
        sudo pacman -Su --quiet --needed --noconfirm neovim python gcc bash-language-server ;;
    *)
        echo -e "\e[31m${OS_ID} based distributions are not supported\e[0m" ; exit 126 ;;
esac

[[ -d ~/.vim ]] || {
    mkdir ~/.vim
    mkdir -p ~/.config/nvim
    cat > ~/.config/nvim/init.vim <<'EOF'
set runtimepath^=~/.vim runtimepath+=~/.vim/after
let &packpath = &runtimepath
source ~/.vimrc
EOF
}

python -m pip install --quiet --user --upgrade pynvim neovim msgpack python-language-server

here="$(dirname "${BASH_SOURCE[0]}")"
for file in "${here}"/.{profile,bash_profile,bashrc,bash_aliases,vimrc} ; do
    [[ -f "${file}" ]] || ln --verbose --force --symbolic --relative "${file}" --target-directory ${HOME}
done

nvim +PlugUpgrade +PlugInstall +PlugUpdate +UpdateRemotePlugins +qa
